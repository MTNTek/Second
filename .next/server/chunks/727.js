"use strict";exports.id=727,exports.ids=[727],exports.modules={5748:(e,t,a)=>{let n;a.d(t,{db:()=>n});var s=a(6571),r=a(6596),o=a(8937),i=a(5890),l=a.n(i),c=a(7327),d=a(5315),u=a.n(d),p=a(2048),y=a.n(p);let m=process.env.DATABASE_URL;if(m&&"postgresql://username:password@localhost:5432/perry_eden_db"!==m&&!m.includes("[PASSWORD]")&&!m.includes("[PROJECT-REF]")&&m.startsWith("postgresql://")){let e=(0,o.Z)(m,{prepare:!1});n=(0,s.t)(e,{schema:c})}else{let e=u().join(process.cwd(),"data"),t=u().join(e,"development.db");y().existsSync(t)||(console.warn("⚠️ Development database not found. Please run: npm run db:init"),y().existsSync(e)||y().mkdirSync(e,{recursive:!0}));let a=new(l())(t);n=(0,r.t)(a)}},5592:(e,t,a)=>{a.d(t,{t:()=>d});var n=a(5748),s=a(7327),r=a(450),o=a(7745);class i{constructor(){this.profileId=process.env.PAYTABS_PROFILE_ID||"",this.serverKey=process.env.PAYTABS_SERVER_KEY||"",this.baseUrl=process.env.PAYTABS_BASE_URL||"https://secure.paytabs.sa"}async createPayment(e){try{let t=(0,r.Mc)(),a={profile_id:this.profileId,tran_type:"sale",tran_class:"ecom",cart_id:e.applicationId,cart_description:"Perry Eden Group - Application Payment",cart_currency:e.currency,cart_amount:e.amount,callback:`${process.env.NEXTAUTH_URL}/api/payments/paytabs/callback`,return:`${process.env.NEXTAUTH_URL}/dashboard?payment=success`,customer_details:{name:e.customerInfo.name,email:e.customerInfo.email,phone:e.customerInfo.phone||"",street1:e.billingAddress?.street||"",city:e.billingAddress?.city||"",state:e.billingAddress?.state||"",country:e.billingAddress?.country||"AE",zip:e.billingAddress?.postalCode||""},payment_token:t},o=await fetch(`${this.baseUrl}/payment/request`,{method:"POST",headers:{Authorization:this.serverKey,"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await o.json();if(4012===i.response_code)return await n.db.insert(s.payments).values({id:t,applicationId:e.applicationId,amount:e.amount.toString(),currency:e.currency,paymentMethod:"paytabs",status:"pending",transactionId:i.tran_ref,paymentData:JSON.stringify(i),createdAt:new Date}),{success:!0,paymentId:t,transactionId:i.tran_ref,paymentUrl:i.redirect_url,status:"pending",message:"Payment initiated successfully",redirectUrl:i.redirect_url};throw Error(i.result||"PayTabs payment failed")}catch(e){return console.error("PayTabs payment error:",e),{success:!1,paymentId:"",status:"failed",message:e instanceof Error?e.message:"Payment processing failed"}}}async verifyPayment(e){try{let t=await fetch(`${this.baseUrl}/payment/query`,{method:"POST",headers:{Authorization:this.serverKey,"Content-Type":"application/json"},body:JSON.stringify({profile_id:this.profileId,tran_ref:e})});return await t.json()}catch(e){throw console.error("PayTabs verification error:",e),e}}}class l{constructor(){this.secretKey=process.env.STRIPE_SECRET_KEY||"",this.publishableKey=process.env.STRIPE_PUBLISHABLE_KEY||""}async createPayment(e){try{let t=(0,r.Mc)(),a={amount:Math.round(100*e.amount),currency:e.currency.toLowerCase(),automatic_payment_methods:{enabled:!0},customer_email:e.customerInfo.email,metadata:{applicationId:e.applicationId,paymentId:t},success_url:`${process.env.NEXTAUTH_URL}/dashboard?payment=success`,cancel_url:`${process.env.NEXTAUTH_URL}/dashboard?payment=cancelled`};return await n.db.insert(s.payments).values({id:t,applicationId:e.applicationId,amount:e.amount.toString(),currency:e.currency,paymentMethod:"stripe",status:"pending",paymentData:JSON.stringify(a),createdAt:new Date}),{success:!0,paymentId:t,status:"pending",message:"Stripe payment session created",paymentUrl:`/api/payments/stripe/checkout?payment_id=${t}`}}catch(e){return console.error("Stripe payment error:",e),{success:!1,paymentId:"",status:"failed",message:e instanceof Error?e.message:"Stripe payment failed"}}}}class c{constructor(){this.clientId=process.env.PAYPAL_CLIENT_ID||"",this.clientSecret=process.env.PAYPAL_CLIENT_SECRET||"",this.baseUrl=process.env.PAYPAL_BASE_URL||"https://api-m.sandbox.paypal.com"}async createPayment(e){try{let t=(0,r.Mc)(),a=await fetch(`${this.baseUrl}/v1/oauth2/token`,{method:"POST",headers:{Authorization:`Basic ${Buffer.from(`${this.clientId}:${this.clientSecret}`).toString("base64")}`,"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=client_credentials"}),o=await a.json(),i=await fetch(`${this.baseUrl}/v2/checkout/orders`,{method:"POST",headers:{Authorization:`Bearer ${o.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({intent:"CAPTURE",purchase_units:[{amount:{currency_code:e.currency,value:e.amount.toString()},description:"Perry Eden Group - Application Payment",custom_id:e.applicationId}],application_context:{return_url:`${process.env.NEXTAUTH_URL}/api/payments/paypal/success`,cancel_url:`${process.env.NEXTAUTH_URL}/dashboard?payment=cancelled`}})}),l=await i.json();if(l.id){await n.db.insert(s.payments).values({id:t,applicationId:e.applicationId,amount:e.amount.toString(),currency:e.currency,paymentMethod:"paypal",status:"pending",transactionId:l.id,paymentData:JSON.stringify(l),createdAt:new Date});let a=l.links.find(e=>"approve"===e.rel)?.href;return{success:!0,paymentId:t,transactionId:l.id,paymentUrl:a,status:"pending",message:"PayPal order created successfully",redirectUrl:a}}throw Error("Failed to create PayPal order")}catch(e){return console.error("PayPal payment error:",e),{success:!1,paymentId:"",status:"failed",message:e instanceof Error?e.message:"PayPal payment failed"}}}}class d{constructor(){this.payTabsProcessor=new i,this.stripeProcessor=new l,this.payPalProcessor=new c}async processPayment(e){try{switch(e.paymentMethod){case"paytabs":return await this.payTabsProcessor.createPayment(e);case"stripe":return await this.stripeProcessor.createPayment(e);case"paypal":return await this.payPalProcessor.createPayment(e);default:return{success:!1,paymentId:"",status:"failed",message:"Unsupported payment method"}}}catch(e){return console.error("Payment processing error:",e),{success:!1,paymentId:"",status:"failed",message:"Internal payment processing error"}}}async getPaymentStatus(e){try{let t=await n.db.query.payments?.findFirst({where:o.eq(s.payments.id,e)});if(!t)throw Error("Payment not found");return{success:!0,payment:{id:t.id,applicationId:t.applicationId,amount:parseFloat(t.amount),currency:t.currency,method:t.paymentMethod,status:t.status,transactionId:t.transactionId,createdAt:t.createdAt,updatedAt:t.updatedAt}}}catch(e){return console.error("Get payment status error:",e),{success:!1,message:e instanceof Error?e.message:"Failed to get payment status"}}}async updatePaymentStatus(e,t,a){await n.db.update(s.payments).set({status:t,paymentData:a?JSON.stringify(a):void 0,updatedAt:new Date}).where((0,o.eq)(s.payments.id,e))}}},7327:(e,t,a)=>{a.r(t),a.d(t,{applicationStatusEnum:()=>y,contactSubmissions:()=>v,documentServices:()=>A,fileUploads:()=>P,notifications:()=>b,paymentStatusEnum:()=>m,payments:()=>w,serviceTypeEnum:()=>f,travelBookings:()=>h,uaeJobApplications:()=>g,userRoleEnum:()=>p,users:()=>_,visaApplications:()=>L,workPermitApplications:()=>N});var n=a(5396),s=a(889),r=a(2140),o=a(8748),i=a(1575),l=a(1401),c=a(2941),d=a(3050),u=a(450);let p=(0,n.ys)("user_role",["admin","user","agent"]),y=(0,n.ys)("application_status",["pending","in_progress","approved","rejected","completed"]),m=(0,n.ys)("payment_status",["pending","processing","completed","failed","refunded"]),f=(0,n.ys)("service_type",["travel","visa","work_permit","document","uae_job"]),_=(0,s.af)("users",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),email:(0,r.fL)("email").unique().notNull(),password:(0,r.fL)("password"),name:(0,r.fL)("name").notNull(),phone:(0,r.fL)("phone"),role:p("role").default("user").notNull(),isVerified:(0,o.O7)("is_verified").default(!1),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),h=(0,s.af)("travel_bookings",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),bookingType:(0,l.L7)("booking_type",{length:50}).notNull(),departure:(0,r.fL)("departure"),destination:(0,r.fL)("destination"),departureDate:(0,i.AB)("departure_date"),returnDate:(0,i.AB)("return_date"),passengers:(0,c._L)("passengers").default(1),rooms:(0,c._L)("rooms").default(1),classType:(0,l.L7)("class_type",{length:20}),totalAmount:(0,d.gH)("total_amount",{precision:10,scale:2}),currency:(0,l.L7)("currency",{length:3}).default("AED"),status:y("status").default("pending").notNull(),specialRequests:(0,r.fL)("special_requests"),contactName:(0,r.fL)("contact_name").notNull(),contactEmail:(0,r.fL)("contact_email").notNull(),contactPhone:(0,r.fL)("contact_phone").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),L=(0,s.af)("visa_applications",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),visaType:(0,l.L7)("visa_type",{length:50}).notNull(),nationality:(0,r.fL)("nationality").notNull(),passportNumber:(0,r.fL)("passport_number").notNull(),passportExpiry:(0,i.AB)("passport_expiry").notNull(),purposeOfVisit:(0,l.L7)("purpose_of_visit",{length:50}).notNull(),intendedArrival:(0,i.AB)("intended_arrival"),duration:(0,c._L)("duration"),totalAmount:(0,d.gH)("total_amount",{precision:10,scale:2}),currency:(0,l.L7)("currency",{length:3}).default("AED"),status:y("status").default("pending").notNull(),processingDays:(0,c._L)("processing_days"),additionalNotes:(0,r.fL)("additional_notes"),contactName:(0,r.fL)("contact_name").notNull(),contactEmail:(0,r.fL)("contact_email").notNull(),contactPhone:(0,r.fL)("contact_phone").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),N=(0,s.af)("work_permit_applications",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),country:(0,l.L7)("country",{length:50}).notNull(),jobTitle:(0,r.fL)("job_title").notNull(),company:(0,r.fL)("company"),salary:(0,d.gH)("salary",{precision:10,scale:2}),currency:(0,l.L7)("currency",{length:3}).default("EUR"),location:(0,r.fL)("location"),workExperience:(0,r.fL)("work_experience"),education:(0,r.fL)("education"),languageSkills:(0,r.fL)("language_skills"),status:y("status").default("pending").notNull(),processingWeeks:(0,c._L)("processing_weeks"),accommodationIncluded:(0,o.O7)("accommodation_included").default(!1),transportIncluded:(0,o.O7)("transport_included").default(!1),contactName:(0,r.fL)("contact_name").notNull(),contactEmail:(0,r.fL)("contact_email").notNull(),contactPhone:(0,r.fL)("contact_phone").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),g=(0,s.af)("uae_job_applications",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),industry:(0,l.L7)("industry",{length:50}).notNull(),jobTitle:(0,r.fL)("job_title").notNull(),experience:(0,l.L7)("experience",{length:20}),expectedSalary:(0,d.gH)("expected_salary",{precision:10,scale:2}),currency:(0,l.L7)("currency",{length:3}).default("AED"),availability:(0,i.AB)("availability"),visaStatus:(0,l.L7)("visa_status",{length:50}),resume:(0,r.fL)("resume_url"),status:y("status").default("pending").notNull(),contactName:(0,r.fL)("contact_name").notNull(),contactEmail:(0,r.fL)("contact_email").notNull(),contactPhone:(0,r.fL)("contact_phone").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),A=(0,s.af)("document_services",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),serviceType:(0,l.L7)("service_type",{length:50}).notNull(),documentType:(0,r.fL)("document_type").notNull(),language:(0,l.L7)("language",{length:20}),urgency:(0,l.L7)("urgency",{length:20}),quantity:(0,c._L)("quantity").default(1),totalAmount:(0,d.gH)("total_amount",{precision:10,scale:2}),currency:(0,l.L7)("currency",{length:3}).default("AED"),status:y("status").default("pending").notNull(),deliveryMethod:(0,l.L7)("delivery_method",{length:20}),specialInstructions:(0,r.fL)("special_instructions"),contactName:(0,r.fL)("contact_name").notNull(),contactEmail:(0,r.fL)("contact_email").notNull(),contactPhone:(0,r.fL)("contact_phone").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),w=(0,s.af)("payments",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),applicationId:(0,r.fL)("application_id").notNull(),applicationType:f("application_type").notNull(),amount:(0,d.gH)("amount",{precision:10,scale:2}).notNull(),currency:(0,l.L7)("currency",{length:3}).notNull(),paymentMethod:(0,l.L7)("payment_method",{length:20}).notNull(),paymentGatewayId:(0,r.fL)("payment_gateway_id"),status:m("status").default("pending").notNull(),paidAt:(0,i.AB)("paid_at"),refundedAt:(0,i.AB)("refunded_at"),refundAmount:(0,d.gH)("refund_amount",{precision:10,scale:2}),metadata:(0,r.fL)("metadata"),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),P=(0,s.af)("file_uploads",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),applicationId:(0,r.fL)("application_id").notNull(),applicationType:f("application_type").notNull(),fileName:(0,r.fL)("file_name").notNull(),originalName:(0,r.fL)("original_name").notNull(),fileSize:(0,c._L)("file_size").notNull(),mimeType:(0,r.fL)("mime_type").notNull(),fileUrl:(0,r.fL)("file_url").notNull(),documentType:(0,l.L7)("document_type",{length:50}),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),b=(0,s.af)("notifications",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),userId:(0,r.fL)("user_id").references(()=>_.id),title:(0,r.fL)("title").notNull(),message:(0,r.fL)("message").notNull(),type:(0,l.L7)("type",{length:20}).notNull(),applicationId:(0,r.fL)("application_id"),isRead:(0,o.O7)("is_read").default(!1),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),v=(0,s.af)("contact_submissions",{id:(0,r.fL)("id").primaryKey().$defaultFn(()=>(0,u.Mc)()),name:(0,r.fL)("name").notNull(),email:(0,r.fL)("email").notNull(),phone:(0,r.fL)("phone"),subject:(0,r.fL)("subject").notNull(),message:(0,r.fL)("message").notNull(),service:(0,l.L7)("service",{length:50}),isReplied:(0,o.O7)("is_replied").default(!1),createdAt:(0,i.AB)("created_at").defaultNow().notNull()})}};